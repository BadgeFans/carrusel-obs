<script>
    const TINT_OPACITY = 0.15;
    const config = {
        timePerLanguage: 5000,
        timePerCard: 10000,
        glitchDuration: 800
    };

    let items = [];
    let cardIndex = 0;
    let lang = 'en';
    let langTimeout = null;
    let cardTimeout = null;

    async function loadBannerItems() {
        try {
            const response = await fetch('https://api.github.com/repos/BadgeFans/carrusel-obs/contents/content/banner');
            if (!response.ok) throw new Error('GitHub fetch failed');
            const files = await response.json();
            const mdFiles = files.filter(f => f.name.endsWith('.md'));
            const loadedItems = [];
            for (const f of mdFiles) {
                const txt = await (await fetch(f.download_url)).text();
                const item = parseFrontmatter(txt);
                if (item) loadedItems.push(item);
            }
            return loadedItems.sort((a,b)=>a.order-b.order);
        } catch(e) {
            console.error('Error loading items:', e);
            return getExampleData();
        }
    }

    function parseFrontmatter(content) {
        const m = content.match(/^---\n([\s\S]*?)\n---/);
        if (!m) return null;
        const data = {};
        m[1].split('\n').forEach(line=>{
            const idx = line.indexOf(':');
            if (idx === -1) return;
            const key = line.substring(0, idx).trim();
            const val = line.substring(idx + 1).trim();
            data[key] = val;
        });
        return {
            order: parseInt(data.order)||0,
            title: data.title||'',
            titleES: data.titleES||'',
            description: data.description||'',
            descriptionES: data.descriptionES||'',
            titleSize: data.titleSize||'42',
            descSize: data.descSize||'22',
            background: data.background||'',
            imageEN: data.imageEN || '',
            imageES: data.imageES || ''
        };
    }

    function getExampleData() {
        return [{
            order:1,
            title:'NEW STREAM SCHEDULE',
            titleES:'NUEVO HORARIO DE STREAM',
            description:'Streaming Monday to Friday from 8 PM to 11 PM EST. Join us for gaming!',
            descriptionES:'Transmitiendo de lunes a viernes de 8 PM a 11 PM EST. ¡Únete para juegos!',
            titleSize:'42', descSize:'22',
            background:'linear-gradient(135deg, #a855f7, #ec4899)',
            imageEN:'https://via.placeholder.com/700x270/a855f7/fff?text=English',
            imageES:'https://via.placeholder.com/700x270/ec4899/fff?text=Español'
        }];
    }

    function applyItem(item){
        const t = document.getElementById('title');
        const d = document.getElementById('description');
        const tint = document.getElementById('tint');
        const img = document.getElementById('langImage');

        t.style.fontSize = (item.titleSize||'42')+'px';
        d.style.fontSize = (item.descSize||'22')+'px';

        if (item.background) {
            tint.style.background = item.background;
            tint.style.opacity = TINT_OPACITY;
            tint.style.display = 'block';
        } else {
            tint.style.display = 'none';
        }

        if (item.imageEN || item.imageES) {
            img.style.display = 'block';
            img.src = (lang === 'en') ? (item.imageEN || item.imageES) : (item.imageES || item.imageEN);
        } else {
            img.style.display = 'none';
        }
    }

    function swapLanguage(item){
        const t = document.getElementById('title');
        const d = document.getElementById('description');
        const g = document.getElementById('glassOverlay');
        const img = document.getElementById('langImage');

        t.classList.add('glitch');
        d.classList.add('glitch');
        g.classList.add('glass-glitch');

        setTimeout(()=>{
            lang = (lang==='en')?'es':'en';
            t.textContent = (lang==='en') ? item.title : (item.titleES || item.title);
            d.textContent = (lang==='en') ? item.description : (item.descriptionES || item.description);

            const nextSrc = (lang==='en') ? (item.imageEN || item.imageES) : (item.imageES || item.imageEN);
            if (nextSrc) {
                img.style.display='block';
                img.src = nextSrc;
            } else {
                img.style.display='none';
            }
        }, config.glitchDuration/2);

        setTimeout(()=>{
            t.classList.remove('glitch');
            d.classList.remove('glitch');
            g.classList.remove('glass-glitch');
        }, config.glitchDuration);
    }

    function scheduleLanguageSwaps(item, startTime) {
        const elapsed = Date.now() - startTime;
        const remaining = config.timePerCard - elapsed;
        
        if (remaining <= 0) return; // Tarjeta terminó
        
        langTimeout = setTimeout(() => {
            swapLanguage(item);
            scheduleLanguageSwaps(item, startTime); // Recursivo
        }, Math.min(config.timePerLanguage, remaining));
    }

    function showCard(index) {
        // Cancelar todos los timeouts anteriores
        if (langTimeout) clearTimeout(langTimeout);
        if (cardTimeout) clearTimeout(cardTimeout);
        
        const item = items[index];
        lang = 'en';
        
        // Limpiar estado
        const tint = document.getElementById('tint');
        const img = document.getElementById('langImage');
        tint.style.display = 'none';
        tint.style.background = '';
        img.style.display = 'none';
        img.src = '';
        
        // Aplicar tarjeta
        applyItem(item);
        document.getElementById('title').textContent = item.title;
        document.getElementById('description').textContent = item.description;
        
        // Programar cambios de idioma
        const startTime = Date.now();
        scheduleLanguageSwaps(item, startTime);
        
        // Programar siguiente tarjeta
        cardTimeout = setTimeout(() => {
            cardIndex = (cardIndex + 1) % items.length;
            showCard(cardIndex);
        }, config.timePerCard);
    }

    function startRotation(){
        if (!items.length) return;
        showCard(cardIndex);
    }

    window.addEventListener('DOMContentLoaded', async ()=>{
        items = await loadBannerItems();
        if (!items.length) items = getExampleData();
        startRotation();
    });
</script>
