<script>
    const TINT_OPACITY = 0.15;
    const config = {
        timePerLanguage: 5000,
        timePerCard: 10000,
        glitchDuration: 800
    };

    async function loadBannerItems() {
        try {
            const response = await fetch('https://api.github.com/repos/BadgeFans/carrusel-obs/contents/content/banner');
            if (!response.ok) throw new Error('GitHub fetch failed');
            const files = await response.json();
            const mdFiles = files.filter(f => f.name.endsWith('.md'));
            const items = [];
            for (const f of mdFiles) {
                const txt = await (await fetch(f.download_url)).text();
                const item = parseFrontmatter(txt);
                if (item) items.push(item);
            }
            return items.sort((a,b)=>a.order-b.order);
        } catch(e) { return getExampleData(); }
    }

    function parseFrontmatter(content) {
        const m = content.match(/^---\n([\s\S]*?)\n---/);
        if (!m) return null;
        const data = {};
        m[1].split('\n').forEach(line=>{
            const idx = line.indexOf(':');
            if (idx === -1) return;
            const key = line.substring(0, idx).trim();
            const val = line.substring(idx + 1).trim();
            if (key==='images') data.images = val.split(',').map(s=>s.trim());
            else data[key] = val;
        });
        return {
            order: parseInt(data.order)||0,
            title: data.title||'',
            titleES: data.titleES||'',
            description: data.description||'',
            descriptionES: data.descriptionES||'',
            titleSize: data.titleSize||'42',
            descSize: data.descSize||'22',
            background: data.background||'',
            imageEN: data.imageEN || '',
            imageES: data.imageES || '',
            images: data.images||[]
        };
    }

    function getExampleData() {
        return [{
            order:1,
            title:'NEW STREAM SCHEDULE',
            titleES:'NUEVO HORARIO DE STREAM',
            description:'Streaming Monday to Friday from 8 PM to 11 PM EST. Join us for gaming, chat, and fun times with the community!',
            descriptionES:'Transmitiendo de lunes a viernes de 8 PM a 11 PM EST. ¡Únete para juegos, chat y buenos momentos con la comunidad!',
            titleSize:'42', descSize:'22',
            background:'linear-gradient(135deg, #a855f7, #ec4899)',
            imageEN:'https://via.placeholder.com/700x270/a855f7/fff?text=English',
            imageES:'https://via.placeholder.com/700x270/ec4899/fff?text=Español'
        }];
    }

    let items=[], cardIndex=0, lang='en';
    let langInterval = null;

    function applyItem(item){
        const t=document.getElementById('title');
        const d=document.getElementById('description');
        const tint=document.getElementById('tint');
        const img=document.getElementById('langImage');

        t.style.fontSize = (item.titleSize||'42')+'px';
        d.style.fontSize = (item.descSize||'22')+'px';

        if (item.background) {
            tint.style.background = item.background;
            tint.style.opacity = TINT_OPACITY;
            tint.style.display = 'block';
        } else {
            tint.style.display = 'none';
        }

        if (item.imageEN || item.imageES) {
            img.style.display = 'block';
            img.src = item.imageEN || item.imageES;
        } else {
            img.style.display = 'none';
            img.removeAttribute('src');
        }
    }

    function swapLanguage(item){
        const t=document.getElementById('title');
        const d=document.getElementById('description');
        const g=document.getElementById('glassOverlay');
        const img=document.getElementById('langImage');

        t.classList.add('glitch');
        d.classList.add('glitch');
        g.classList.add('glass-glitch');

        setTimeout(()=>{
            lang = (lang==='en')?'es':'en';
            t.textContent = (lang==='en') ? item.title : (item.titleES || item.title);
            d.textContent = (lang==='en') ? item.description : (item.descriptionES || item.description);

            const nextSrc = (lang==='en') ? (item.imageEN || item.imageES || '') : (item.imageES || item.imageEN || '');
            if (nextSrc) {
                img.style.display='block';
                if (img.src !== nextSrc) img.src = nextSrc;
            } else {
                img.style.display='none';
                img.removeAttribute('src');
            }
        }, config.glitchDuration/2);

        setTimeout(()=>{
            t.classList.remove('glitch');
            d.classList.remove('glitch');
            g.classList.remove('glass-glitch');
        }, config.glitchDuration);
    }

    function showCard(index) {
        // Limpiar interval anterior
        if (langInterval) clearInterval(langInterval);
        
        const item = items[index];
        lang = 'en';
        
        // Aplicar la tarjeta
        applyItem(item);
        document.getElementById('title').textContent = item.title;
        document.getElementById('description').textContent = item.description;
        
        // Iniciar cambio de idioma
        langInterval = setInterval(() => swapLanguage(item), config.timePerLanguage);
    }

    function startRotation(){
        if (!items.length) return;
        
        // Mostrar primera tarjeta
        showCard(cardIndex);
        
        // Cambiar de tarjeta cada X segundos
        setInterval(() => {
            cardIndex = (cardIndex + 1) % items.length;
            showCard(cardIndex);
        }, config.timePerCard);
    }

    window.addEventListener('DOMContentLoaded', async ()=>{
        items = await loadBannerItems();
        if (!items.length) items = getExampleData();
        startRotation();
    });
</script>
