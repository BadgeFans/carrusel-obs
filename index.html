<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrusel Vertical</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="carousel-wrapper">
        <div class="carousel-track" id="carousel-track">
            <!-- Los items se cargar√°n autom√°ticamente desde el CMS -->
        </div>
    </div>
    
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
        // Funci√≥n para calcular horas restantes
        function getHoursRemaining(endDateStr) {
            try {
                // Parsear fecha en formato DD/MM/YYYY HH:MM o DD/MM/YYYY
                const parts = endDateStr.trim().split(' ');
                const dateParts = parts[0].split('/');
                
                let hours = 23, minutes = 59;
                if (parts.length > 1) {
                    const timeParts = parts[1].split(':');
                    hours = parseInt(timeParts[0]) || 23;
                    minutes = parseInt(timeParts[1]) || 59;
                }
                
                const endDate = new Date(
                    parseInt(dateParts[2]), // year
                    parseInt(dateParts[1]) - 1, // month (0-indexed)
                    parseInt(dateParts[0]), // day
                    hours,
                    minutes
                );
                
                const now = new Date();
                const diff = endDate - now;
                
                if (diff <= 0) return null; // Evento terminado
                
                const hoursRemaining = Math.floor(diff / (1000 * 60 * 60));
                return hoursRemaining;
            } catch (e) {
                console.error('Error parsing date:', e);
                return null;
            }
        }
        
        // Cargar items desde el CMS
        async function loadCarouselItems() {
            try {
                const response = await fetch('https://api.github.com/repos/BadgeFans/carrusel-obs/contents/content/carousel');
                const files = await response.json();
                
                const track = document.getElementById('carousel-track');
                const items = [];
                
                for (const file of files) {
                    const fileResponse = await fetch(file.download_url);
                    const fileContent = await fileResponse.text();
                    
                    const match = fileContent.match(/---\n([\s\S]*?)\n---/);
                    if (match) {
                        const frontmatter = match[1];
                        const item = { order: 999 }; // default order
                        
                        frontmatter.split('\n').forEach(line => {
                            const colonIndex = line.indexOf(':');
                            if (colonIndex > -1) {
                                const key = line.substring(0, colonIndex).trim();
                                const value = line.substring(colonIndex + 1).trim();
                                item[key] = value;
                            }
                        });
                        
                        items.push(item);
                    }
                }
                
                if (items.length === 0) {
                    items.push(
                        { order: 1, title: '!Alone', icon: 'üéÆ', dateStart: '07/10/2025', dateEnd: '23/10/2025 23:59', status: 'live', showCountdown: 'true' },
                        { order: 2, title: '!Low', icon: 'üíÄ', dateStart: '07/10/2025', dateEnd: '23/10/2025 23:59', status: 'live', showCountdown: 'true' },
                        { order: 3, title: '!Totodile', icon: 'üêâ', dateStart: '20/10/2025', dateEnd: '22/10/2025 23:59', status: 'live', showCountdown: 'true' },
                        { order: 4, title: '!Tepig', icon: 'üî•', dateStart: '18/10/2025', dateEnd: '20/10/2025 23:59', status: 'toolate', showCountdown: 'false' },
                        { order: 5, title: '!Chikorita', icon: 'üçÉ', dateStart: '16/10/2025', dateEnd: '18/10/2025 23:59', status: 'toolate', showCountdown: 'false' },
                        { order: 6, title: '!LoL Worlds', icon: 'üåç', dateStart: '10/10/2025', dateEnd: '10/11/2025 23:59', status: 'live', showCountdown: 'true' },
                        { order: 7, title: '!Battle', icon: '‚öîÔ∏è', dateStart: '05/10/2025', dateEnd: '30/10/2025 23:59', status: 'live', showCountdown: 'true' },
                        { order: 8, title: '!Mission', icon: 'üéØ', dateStart: '01/10/2025', dateEnd: '25/10/2025 23:59', status: 'live', showCountdown: 'true' },
                        { order: 9, title: '!Champion', icon: 'üèÜ', dateStart: '12/10/2025', dateEnd: '28/10/2025 23:59', status: 'live', showCountdown: 'true' }
                    );
                }
                
                // Ordenar por el campo "order"
                items.sort((a, b) => {
                    const orderA = parseInt(a.order) || 999;
                    const orderB = parseInt(b.order) || 999;
                    return orderA - orderB;
                });
                
                const allItems = [...items, ...items];
                
                allItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'carousel-item';
                    
                    let iconHTML;
                    if (item.icon && (item.icon.startsWith('http') || item.icon.startsWith('/assets'))) {
                        iconHTML = `<img src="${item.icon}" alt="badge" style="width: 60px; height: 60px; object-fit: contain; border-radius: 8px;">`;
                    } else {
                        iconHTML = item.icon || '‚≠ê';
                    }
                    
                    const statusText = item.status === 'live' ? 'LIVE' : 'Too late';
                    
                    // Calcular horas restantes
                    let countdownHTML = '';
                    const showCountdown = item.showCountdown === 'true' || item.showCountdown === true;
                    
                    if (showCountdown && item.status === 'live') {
                        const hoursLeft = getHoursRemaining(item.dateEnd);
                        if (hoursLeft !== null && hoursLeft > 0) {
                            countdownHTML = `<div class="countdown">‚è±Ô∏è ${hoursLeft}h restantes</div>`;
                        }
                    }
                    
                    div.innerHTML = `
                        <div class="icon">${iconHTML}</div>
                        <div class="info">
                            <h3>${item.title}</h3>
                            <span class="status ${item.status}">${statusText}</span>
                            ${countdownHTML}
                            <p class="date">${item.dateStart} - ${item.dateEnd.split(' ')[0]}</p>
                        </div>
                    `;
                    
                    track.appendChild(div);
                });
                
            } catch (error) {
                console.error('Error cargando items:', error);
                loadDefaultItems();
            }
        }
        
        function loadDefaultItems() {
            const track = document.getElementById('carousel-track');
            const defaultItems = [
                { order: 1, title: '!Alone', icon: 'üéÆ', dateStart: '07/10/2025', dateEnd: '23/10/2025 23:59', status: 'live' },
                { order: 2, title: '!Low', icon: 'üíÄ', dateStart: '07/10/2025', dateEnd: '23/10/2025 23:59', status: 'live' },
                { order: 3, title: '!Totodile', icon: 'üêâ', dateStart: '20/10/2025', dateEnd: '22/10/2025 23:59', status: 'live' },
                { order: 4, title: '!Tepig', icon: 'üî•', dateStart: '18/10/2025', dateEnd: '20/10/2025 23:59', status: 'toolate' },
                { order: 5, title: '!Chikorita', icon: 'üçÉ', dateStart: '16/10/2025', dateEnd: '18/10/2025 23:59', status: 'toolate' },
                { order: 6, title: '!LoL Worlds', icon: 'üåç', dateStart: '10/10/2025', dateEnd: '10/11/2025 23:59', status: 'live' },
                { order: 7, title: '!Battle', icon: '‚öîÔ∏è', dateStart: '05/10/2025', dateEnd: '30/10/2025 23:59', status: 'live' },
                { order: 8, title: '!Mission', icon: 'üéØ', dateStart: '01/10/2025', dateEnd: '25/10/2025 23:59', status: 'live' },
                { order: 9, title: '!Champion', icon: 'üèÜ', dateStart: '12/10/2025', dateEnd: '28/10/2025 23:59', status: 'live' }
            ];
            
            const allItems = [...defaultItems, ...defaultItems];
            
            allItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'carousel-item';
                
                const statusText = item.status === 'live' ? 'LIVE' : 'Too late';
                const hoursLeft = getHoursRemaining(item.dateEnd);
                let countdownHTML = '';
                if (hoursLeft !== null && hoursLeft > 0 && item.status === 'live') {
                    countdownHTML = `<div class="countdown">‚è±Ô∏è ${hoursLeft}h</div>`;
                }
                
                div.innerHTML = `
                    <div class="icon">${item.icon}</div>
                    <div class="info">
                        <h3>${item.title}</h3>
                        <span class="status ${item.status}">${statusText}</span>
                        ${countdownHTML}
                        <p class="date">${item.dateStart} - ${item.dateEnd.split(' ')[0]}</p>
                    </div>
                `;
                
                track.appendChild(div);
            });
        }
        
        loadCarouselItems();
        
        // Actualizar el contador cada minuto
        setInterval(() => {
            loadCarouselItems();
        }, 60000);
    </script>
</body>
</html>
